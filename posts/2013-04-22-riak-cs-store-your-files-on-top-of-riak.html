<!DOCTYPE html>
<html>
  <head>
    <title>jbbarth.com - Riak CS - store your files on top of Riak</title>
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/text.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/960.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/app.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/rainbow/github.css" />
    <script type="text/javascript" src="/javascripts/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="/javascripts/rainbow-custom.min.js"></script>
    <script type="text/javascript" src="/javascripts/app.js"></script>
    <meta http-equiv="cache-control" content="max-age=10, must-revalidate" />
    <meta charset="utf-8">
    <meta name="generator" content="nanoc 3.2.3">
  </head>
  <body>
    <div id="container" class="container_16">
      <div class="grid_4">
        <div id="sidebar">
  <a href="/" class="sitetitle">jbbarth.com</a>
  <p>
    I'm a sysadmin & developer from Paris, France. I love building tools for
    ops, and I am an irregular contributor to many open-source projects.
  </p>
  <p>
    Find me as jbbarth on <a href="https://github.com/jbbarth">GitHub</a> and
    <a href="https://twitter.com/jbbarth">Twitter</a>, or salvor on Freenode
    IRC.
  </p>
</div>

      </div>
      <div class="grid_12">
        <div id="content">
          <h1>Riak CS: store your files on top of Riak</h1>

<p>Last month <a href="http://basho.com">Basho Tecnologies</a>, the company behind <a href="http://basho.com/riak/">Riak</a>,
open-sourced <a href="http://basho.com/riak-cloud-storage/">Riak CS</a>, the storage software they built on top of Riak.
Riak is already known for being a distributed, reliable, fault-tolerant database. I already explored a bit
Riak back in 2011 <a href="/posts/2011-04-21-a-first-sight-at-riak.html">here</a> and <a href="/posts/2011-04-23-basic-usage-of-riak-in.html">here</a>.</p>

<p>Riak CS has an Amazon S3 compatible API. It's nice because there are already many tools available which
support S3 API, so there's already a bunch of client code and libraries compatible with Riak CS as a file
storage system. Note that this is not unique: that's also the case of OpenStack's Swift, EMC's Atmos,
Eucalyptus or Nimbus.io, though I don't have experience with any of them. Basho provides some comparison
points in their docs if you're interested.</p>

<h2>Installing Riak CS</h2>

<p>Installing Riak CS for test and development purposes is easy with <a href="http://docs.basho.com/riakcs/latest/riakcs-tutorials/fast-track/">The Riak CS Fast Track</a>,
especially <a href="http://docs.basho.com/riakcs/latest/tutorials/fast-track/Building-a-Virtual-Test-Environment/">Building a Virtual Testing Environment</a>.
No need to repeat Basho docs here, just follow the steps they suggest. Note that sometimes Vagrant fails
just after the box download, you might want to retry the <code>vagrant up</code> command then.</p>

<p><em>Just a quick note here: I first tried to follow the process 2 days after Basho open-sourced Riak CS. It
was a bit rough around the edges back then but the Basho team has been incredibly responsive and
helpful to get things running properly. I rarely saw such a level of care before, it's really awesome
and it just makes me want to work more with Riak/Riak CS in the future. The whole process has been made
as smooth as possible since then, but if you have a problem, I encourage you to ping them on IRC or on
the mailing list.</em></p>

<p>After the Vagrant box has been installed and provisionned successfully, you should have a running
Riak CS node (under Ubuntu 12.04) and your admin credentials in hand. Time to play!</p>

<h2>Basic bucket/file usage</h2>

<p>You can follow the <a href="http://docs.basho.com/riakcs/latest/tutorials/fast-track/Testing-the-Installation/">Testing the Riak CS Installation</a>
page. I recommend installing a recent version of <code>s3cmd</code> through the tarball if you're under MacOSX.</p>

<p>I'll skip the <code>-c ~/.s3cfgfasttrack</code> parameter below and assume you had left the config file in
its default place like me.</p>

<p>You should now be able to create a new bucket:</p>

<pre><code>s3cmd mb s3://test-bucket
</code></pre>

<p>List buckets through ls:</p>

<pre><code>s3cmd ls
</code></pre>

<p>Put a file in the newly created bucket:</p>

<pre><code>s3cmd put /etc/hosts s3://test-bucket
</code></pre>

<p>See the file is here in the bucket:</p>

<pre><code>s3cmd ls s3://test-bucket
</code></pre>

<p>Get the file, optionnally providing a destination path:</p>

<pre><code>s3cmd get s3://test-bucket/hosts /tmp/hosts
</code></pre>

<p>And finally remove it from the bucket if you want:</p>

<pre><code>s3cmd del s3://test-bucket/hosts
</code></pre>

<p>Pretty standard features for a file storage service or even any &quot;filesystem&quot;. There are plenty
of other standard features (sync a subtree, move, copy, rename, symlink, etc.). There are also
advanced features such as ACLs depending on the user, you may run <code>s3cmd --help</code> and try to
play with them yourself if you want.</p>

<h2>Managing users</h2>

<p>The Fast Track install we followed before comes with a handy tool to manage your Riak CS users,
&quot;Riak CS Control&quot;. It's a simple Ember.js app that allows you to issue basic CRUD operations on
your users and change/revoke their secret key if needed.</p>

<p>It should be started by default on port 8000, so just point your browser to http://localhost:8000
and see what can be done by yourself!</p>

<p><img src="/screenshots/riak-cs-control.png" alt="Riak CS Control screenshot">
</p>

<p>If you need more maybe you should have a look at <a href="https://github.com/basho/riak_control">Riak Control</a>
(which manages Riak, not Riak CS, and is a successor to Rekon if I'm not mistaken).</p>

<h2>Monitoring</h2>

<p>If you want to dig into what your Riak CS cluster is doing under the hood, you might want to retrieve
<a href="http://docs.basho.com/riakcs/latest/cookbooks/Monitoring-and-Metrics/">global metrics</a>. Those metrics
are exposed through the HTTP interface but they require authentication.</p>

<p>I don't have much experience with that, Authentication doesn't seem easy to achieve in a web browser
or with curl directly. More explanations <a href="http://docs.basho.com/riakcs/latest/cookbooks/Authentication/">here</a>.</p>

<p>The <a href="http://aws.amazon.com/code/128">s3curl tool</a> will help you sign your requests automatically
depending on your secret key. You can download it and move the perl script to <code>/usr/local/bin/s3curl</code>
so that it will be easy to use. You'll also have to configure <code>~/.s3curl</code>, in my case:</p>

<pre><code>%awsSecretAccessKeys = (
  personal =&gt; {
    id =&gt; 'HQ2BG22_AEZSYZNEKJSC',
    key =&gt; 'GxDAOaze_ec7IazUg7Hw73ZcL8QLmgmf0Pws3w==',
  },
);
</code></pre>

<p>Just to test it works, you can upload a file with <code>s3cmd</code> and then test you retrieve it with <code>s3curl</code>:</p>

<pre><code>s3cmd put /etc/hosts s3://test-bucket
</code></pre>

<p>Then:</p>

<pre><code>http_proxy=localhost:8080 s3curl --id personal -- http://s3.amazonaws.com/test-bucket/hosts
#=&gt; should display your /etc/hosts file
</code></pre>

<p>If that doesn't work, the <code>--debug</code>flag can be useful to see the request/response cycle and understand
what happens.</p>

<p>Now that you've a working s3curl config, you can retrieve some statistics:</p>

<pre><code>http_proxy=localhost:8080 s3curl --id personal -- -s http://s3.amazonaws.com/riak-cs/stats | python -mjson.tool
</code></pre>

<p>I used the <code>-s</code> option to remove curl progress informations, and the <code>| python -mjson.tool</code> to pretty-print
the result. You'll see you access various global statistics about your Riak CS cluster, great isn't it ? If
you need more &quot;real-time&quot; debugging Riak CS has some dtrace probes but I didn't try it myself. The full doc
is available <a href="http://docs.basho.com/riakcs/latest/cookbooks/Monitoring-and-Metrics/">here</a>.</p>

<p>There's also a magic <code>usage</code> bucket which exposes usage statistics for each user, docs
<a href="http://docs.basho.com/riakcs/latest/cookbooks/Querying-Access-Statistics/">here</a> and in the following sections.</p>

<h2>A conclusion</h2>

<p>I think that's enough as a first overview of Riak CS. Here are a few points I leave here as a conclusion:</p>

<p>1/ Riak CS leaves on top of Riak. So you can expect it to be reliable, easy to scale, and easy to
operate. And it has some monitoring goodies so day-to-day monitoring shouldn't be a problem.</p>

<p>2/ Riak CS is run by Basho. From my 2 short experiences in Basho's world, you can expect a truly
amazing support. Of course commercial support is recommended if you want extra features or some
guarantees, but that's not my case for now.</p>

<p>3/ The ecosystem is already here. For instance there's already a <a href="https://github.com/ka8725/redmine_s3">redmine_s3</a>
plugin that just lacks proxy support to work with Riak CS. I bet I'll work on that in the next
few weeks so that I'll be able to store big files in my Redmine instance for free.</p>

<p>To sum it up, I can't wait to have the opportunity to dig into Riak CS a bit more! Stay tuned ;-)</p>

        </div>
      </div>
    </div>
    <div id=footer>
  <div class=container_16>
    <div class=grid_7>
      <h2>Promoted Posts</h2>
      <ul>
        <li><a href="/posts/2011-06-12-cas-authentication-for-redmine.html">CAS Authentication for Redmine</a></li>
        <li><a href="/posts/2011-12-12-trying-cloudfoundry-with-vagrant-and.html">Trying CloudFoundry with Vagrant ... and some patience</a></li>
        <li><a href="/posts/2009-08-24-supervision-cpu-via-snmp.html">[fr] Supervision CPU via SNMP</a></li>
        <li><a href="/posts/2009-06-06-extension-dun-disque-lvm-en.html">[fr] Extension d'un disque LVM en environnement SAN</a></li>
        <li><a href="/posts/2008-05-21-introduction-a-lurl-rewriting.html">[fr] Introduction à l'URL rewriting</a></li>
        <li><a href="/posts/2008-05-16-introduction-aux-expressions-regulieres.html">[fr] Introduction aux expressions régulières</a></li>
      </ul>
    </div>
    <div class=grid_7>
      <h2>Projects</h2>
      <ul>
        <li>
          <b><a href="http://www.redmine.org/">Redmine</a></b>
          <em>(occasional contributor, prolific plugin author)</em>
          <br>
          Flexible project management web application. You can find all my plugins
          <a href="https://github.com/jbbarth">on GitHub</a>.
        </li>
        <li>
          <b><a href="http://cartoque.org/">Cartoque</a></b>
          <em>(main developer)</em>
          <br>
          Tiny CMDB solution I built for my current job.
        </li>
      </ul>
    </div>
    <div class=grid_2>
      <h2>Links</h2>
      <p>
        <a href="/notes.html">Tech notes</a>
      </p>
    </div>
  </div>
</div>

    <script type="text/javascript">
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4e3bca6b613f5d70ee000001');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    </script>
  </body>
</html>
