<!DOCTYPE html>
<html>
  <head>
    <title>jbbarth.com - Basic usage of Riak in Rails</title>
    <link href="http://fonts.googleapis.com/css?family=Lobster+Two:700|Open+Sans:400,600,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/960.css" />
    <link rel="stylesheet" type="text/css" media="all" href="/stylesheets/app.css" />
    <meta http-equiv="cache-control" content="max-age=10, must-revalidate" />
    <meta charset="utf-8">
    <meta name="generator" content="nanoc 3.2.3">
  </head>
  <body>
    <div id="container" class="container_16">
      <div class="grid_4">
        <div id="sidebar">
  <div class=sitetitle>
    <a href="/">jbbarth.com</a>
  </div>
  <p>
    I'm a sysadmin &amp; developer from Paris, France. I love building tools for
    ops, and I'm an irregular contributor to many open-source projects. More
    <a href="/portfolio.html">here</a>.
  </p>
</div>

      </div>
      <div class="grid_12">
        <div id="content">
          <h1>Basic usage of Riak in Rails</h1>

<p>OK, <a href="http://jbbarth.com/posts/2011-04-21-a-first-sight-at-riak.html">you’re convinced</a> that Riak is a great database, now you want to use it in
your Rails 3 app. You should really have a look at <a href="http://forms.basho.com/riak-and-rails-a-powerful-combination-attended-p/">the advices from
Basho</a>, and especially the <a href="http://www.slideshare.net/seancribbs/riak-with-rails">Riak with Rails</a> slides from Sean Cribbs.</p>

<p>So first, let’s install the rich ruby client for Riak, ripple, built on top of riak-client. Simply add the following lines to your
<code>Gemfile</code>:</p>

<pre><code data-language=ruby>gem 'ripple'    #=> riak orm ; installs "riak-client" as a dependency
gem 'excon'     #=> faster http
gem 'yajl-ruby' #=> faster json
</code></pre>

<p>…and of course run <code>bundle</code> command.</p>

<p>Then generate your ripple config with:</p>

<pre><code data-language=ruby>rails generate ripple
</code></pre>

<p>Optionnaly you can configure the <code>config/ripple.yml</code> file. With the environment I used in <a href=
"http://jbbarth.com/posts/2011-04-21-a-first-sight-at-riak.html">my previous article</a>, I had to change the riak server’s port (default is 8098, I had to
change it to 8091, 92 or 93 for my development cluster).</p>

<p>Then generate a first model:</p>

<pre><code data-language=ruby>rails generate ripple:model Article title:string content:text
</code></pre>

<p>The generated <code>app/models/article.rb</code> looks like this:</p>

<pre><code data-language=ruby>class Article
  include Ripple::Document
   
  property :title, String
  property :content, String
end
</code></pre>

<p>You can optionnaly add <code>timestamps!</code> if you want to have <code>created_at/updated_at</code> fields updated automatically by ripple.</p>

<p>You can now test everything runs fine in a <code>rails console</code> session:</p>

<pre><code data-language=ruby>>> Article.all
=> []
>> Article.create(:title => "A shiny title", :content => "Lorem ipsum blah bleh")
=> &lt;Article:Fp1RZWPRDcDLLjDv8aJ0t3p0C5i created_at=2011-04-23 16:25:13 UTC title="A shiny title" content="Lorem ipsum blah bleh" updated_at=2011-04-23 16:25:13 UTC>
</code></pre>

<p>Looks ok, but the key isn’t so pretty. After a quick search on google, it <a href=
"http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-February/003186.html">appears</a> that this key is auto-generated by Riak if not provided
by the client, and it’s pretty easy to define your own key format. I personnaly wanted the creation date and the title in the key:</p>

<pre><code data-language=ruby>def key
  @key ||= "#{created_at.strftime("%Y%m%d%H%M%S")}-#{title.parameterize}"
end
</code></pre>

<p>Now it looks better:</p>

<pre><code data-language=ruby>>> reload!
Reloading...
=> true
>> Article.create(:title => "A shiny title", :content => "Lorem ipsum blah bleh")
=> &lt;Article:20110423182948-a-shiny-title created_at=2011-04-23 16:29:48 UTC title="A shiny title" content="Lorem ipsum blah bleh" updated_at=2011-04-23 16:29:48 UTC>
</code></pre>

<p>It seems there’s a tiny problem with <code>Article.all</code>, since it doesn’t contain the newly created item. I’ll ask about that on the riak mailing
list, but it seems Riak client does a bit of caching. If you really need it, reset the cache by hand, it’s ugly but it works:</p>

<pre><code data-language=ruby>>> Article.all
=> []
>> Ripple.client.instance_variable_set(:@bucket_cache,nil)
=> nil
>> Article.all
=> [&lt;Article:20110423183635-a-shiny-title created_at=2011-04-23 16:36:35 UTC title="A shiny title" content="Lorem ipsum blah bleh" updated_at=2011-04-23 16:36:35 UTC>]
</code></pre>

<p>Now, what about the controller side ? This is where Rails 3 has become a powerful solution, it’s database agnostic. I generated a scaffold with the 7
standard crud actions:</p>

<pre><code data-language=ruby>rails generate scaffold Article title:string content:text
</code></pre>

<p>It works for 6 of the 7 elementary actions, but I must admit I had a tiny problem with the <code>destroy</code> action, because of <a href=
"https://rails.lighthouseapp.com/projects/8994/tickets/5646-validates_associated-throws-cant-modify-frozen-object-error">a bug in ActiveModel</a>. It’s
described <a href="http://boblail.tumblr.com/post/2528265548/using-validates-associated-with-composed-of-and">here</a> with a workaround, so I added those 2
lines in my Article model:</p>

<pre><code data-language=ruby>  def validation_context=(value); end
  def initialize(*args); errors; super(*args); end
</code></pre>

<p>I’m not really sure which impact it will have on my validations, but validations and links between objects are for the next article. That’s all for today,
hope this article will be useful for some of you!</p>

<p><strong>edit</strong>: replaced ‘curb’ gem by ‘excon’</p>

        </div>
      </div>
    </div>
    <script type="text/javascript">
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4e3bca6b613f5d70ee000001');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    </script>
  </body>
</html>
