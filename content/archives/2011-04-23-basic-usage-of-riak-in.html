---
title: "Basic usage of Riak in Rails"
---

<h1>Basic usage of Riak in Rails</h1><p>OK, <a href="http://jbbarth.com/archives/2011/4/21/a_first_sight_at_riak/">you&#8217;re convinced</a> that Riak is a great database, now you want to use it in your Rails 3 app. You should really have a look at <a href="http://forms.basho.com/riak-and-rails-a-powerful-combination-attended-p/">the advices from Basho</a>, and especially the <a href="http://www.slideshare.net/seancribbs/riak-with-rails">Riak with Rails</a> slides from Sean Cribbs.</p>
<p>So first, let&#8217;s install the rich ruby client for Riak, ripple, built on top of riak-client. Simply add the following lines to your <code>Gemfile</code>:</p>
<div class="CodeRay">
  <div class="code"><pre>gem <span class="s"><span class="dl">'</span><span class="k">ripple</span><span class="dl">'</span></span>    <span class="c">#=&gt; riak orm ; installs &quot;riak-client&quot; as a dependency</span>
gem <span class="s"><span class="dl">'</span><span class="k">excon</span><span class="dl">'</span></span>     <span class="c">#=&gt; faster http</span>
gem <span class="s"><span class="dl">'</span><span class="k">yajl-ruby</span><span class="dl">'</span></span> <span class="c">#=&gt; faster json</span></pre></div>
</div>
<p>&#8230;and of course run <code>bundle</code> command.</p>
<p>Then generate your ripple config with:</p>
<div class="CodeRay">
  <div class="code"><pre>rails generate ripple</pre></div>
</div>
<p>Optionnaly you can configure the <code>config/ripple.yml</code> file. With the environment I used in <a href="http://jbbarth.com/archives/2011/4/21/a_first_sight_at_riak/">my previous article</a>, I had to change the riak server&#8217;s port (default is 8098, I had to change it to 8091, 92 or 93 for my development cluster).</p>
<p>Then generate a first model:</p>
<div class="CodeRay">
  <div class="code"><pre>rails generate ripple:model Article title:string content:text</pre></div>
</div>
<p>The generated <code>app/models/article.rb</code> looks like this:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="r">class</span> <span class="cl">Article</span>
  include <span class="co">Ripple</span>::<span class="co">Document</span>
   
  property <span class="sy">:title</span>, <span class="co">String</span>
  property <span class="sy">:content</span>, <span class="co">String</span>
<span class="r">end</span></pre></div>
</div>
<p>You can optionnaly add <code>timestamps!</code> if you want to have <code>created_at/updated_at</code> fields updated automatically by ripple.</p>
<p>You can now test everything runs fine in a <code>rails console</code> session:</p>
<div class="CodeRay">
  <div class="code"><pre>&gt;&gt; Article.all
=&gt; []
&gt;&gt; Article.create(:title =&gt; &quot;A shiny title&quot;, :content =&gt; &quot;Lorem ipsum blah bleh&quot;)
=&gt; &lt;Article:Fp1RZWPRDcDLLjDv8aJ0t3p0C5i created_at=2011-04-23 16:25:13 UTC title=&quot;A shiny title&quot; content=&quot;Lorem ipsum blah bleh&quot; updated_at=2011-04-23 16:25:13 UTC&gt;</pre></div>
</div>
<p>Looks ok, but the key isn&#8217;t so pretty. After a quick search on google, it <a href="http://lists.basho.com/pipermail/riak-users_lists.basho.com/2011-February/003186.html">appears</a> that this key is auto-generated by Riak if not provided by the client, and it&#8217;s pretty easy to define your own key format. I personnaly wanted the creation date and the title in the key:</p>
<div class="CodeRay">
  <div class="code"><pre>  <span class="r">def</span> <span class="fu">key</span>
    <span class="iv">@key</span> ||= <span class="s"><span class="dl">&quot;</span><span class="il"><span class="idl">#{</span>created_at.strftime(<span class="s"><span class="dl">&quot;</span><span class="k">%Y%m%d%H%M%S</span><span class="dl">&quot;</span></span>)<span class="idl">}</span></span><span class="k">-</span><span class="il"><span class="idl">#{</span>title.parameterize<span class="idl">}</span></span><span class="dl">&quot;</span></span>
  <span class="r">end</span></pre></div>
</div>
<p>Now it looks better:</p>
<div class="CodeRay">
  <div class="code"><pre>&gt;&gt; reload!
Reloading...
=&gt; true
&gt;&gt; Article.create(:title =&gt; &quot;A shiny title&quot;, :content =&gt; &quot;Lorem ipsum blah bleh&quot;)
=&gt; &lt;Article:20110423182948-a-shiny-title created_at=2011-04-23 16:29:48 UTC title=&quot;A shiny title&quot; content=&quot;Lorem ipsum blah bleh&quot; updated_at=2011-04-23 16:29:48 UTC&gt;</pre></div>
</div>
<p>It seems there&#8217;s a tiny problem with <code>Article.all</code>, since it doesn&#8217;t contain the newly created item. I&#8217;ll ask about that on the riak mailing list, but it seems Riak client does a bit of caching. If you really need it, reset the cache by hand, it&#8217;s ugly but it works:</p>
<div class="CodeRay">
  <div class="code"><pre>&gt;&gt; Article.all
=&gt; []
&gt;&gt; Ripple.client.instance_variable_set(:@bucket_cache,nil)
=&gt; nil
&gt;&gt; Article.all
=&gt; [&lt;Article:20110423183635-a-shiny-title created_at=2011-04-23 16:36:35 UTC title=&quot;A shiny title&quot; content=&quot;Lorem ipsum blah bleh&quot; updated_at=2011-04-23 16:36:35 UTC&gt;]</pre></div>
</div>
<p>Now, what about the controller side ? This is where Rails 3 has become a powerful solution, it&#8217;s database agnostic. I generated a scaffold with the 7 standard crud actions:</p>
<div class="CodeRay">
  <div class="code"><pre>rails generate scaffold Article title:string content:text</pre></div>
</div>
<p>It works for 6 of the 7 elementary actions, but I must admit I had a tiny problem with the <code>destroy</code> action, because of <a href="https://rails.lighthouseapp.com/projects/8994/tickets/5646-validates_associated-throws-cant-modify-frozen-object-error">a bug in ActiveModel</a>. It&#8217;s described <a href="http://boblail.tumblr.com/post/2528265548/using-validates-associated-with-composed-of-and">here</a> with a workaround, so I added those 2 lines in my Article model:</p>
<div class="CodeRay">
  <div class="code"><pre>  <span class="r">def</span> <span class="fu">validation_context=</span>(value); <span class="r">end</span>
  <span class="r">def</span> <span class="fu">initialize</span>(*args); errors; <span class="r">super</span>(*args); <span class="r">end</span></pre></div>
</div>
<p>I&#8217;m not really sure which impact it will have on my validations, but validations and links between objects are for the next article. That&#8217;s all for today, hope this article will be useful for some of you!</p>
<p><strong>edit</strong>: replaced &#8216;curb&#8217; gem by &#8216;excon&#8217;</p>
