---
title: "Vérifier l'état des interfaces d'un switch fibre"
---

<h1>Vérifier l'état des interfaces d'un switch fibre</h1>

<p>Là où je bosse, on a la chance (?) de disposer d’un <a href="http://fr.wikipedia.org/wiki/R%C3%A9seau_de_stockage_SAN"><span class="caps">SAN</span></a>,
c’est-à-dire d’un réseau dédié au stockage. En l’occurence c’est un réseau fibre, et tous les flux passent par deux switches fibre McData Sphereon 4500…
qu’il faut surveiller d’une manière ou d’une autre.</p>

<p>En l’occurrence on surveille tout ça par Nagios. L’ancien script (qui doit faire partie des nagios plugins du site officiel ?) vérifiait les interfaces
une par une, ce qui est gênant dans un environnement évolutif (oubli d’interfaces non surveillées!). Il faisait d’autres choses (check trafic rx/tx, errors)
que mon script ne fait pas, mais il ne demande qu’à être amélioré ;-)</p>

<p>Voici donc un script de remplacement qui check toutes les interfaces d’un coup. Gros avantage : on passe les ports non branchés en exception, mais si un
port est vu “up” et qu’il est en exception le script sort en Critical. Cela force à maintenir la liste des exceptions à jour ;-)</p>

<p>PS: Il faut bien sûr que ruby soit installé sur votre serveur de supervision.</p>

<div class="CodeRay">
  <div class="code">
    <pre>



"pc">ARGV</span>.length &lt;= <span class="i">3</span>
puts <span class="s"><span class="dl">"</span><span class="k">Mauvais format :</span><span class="dl">"</span></span>
puts <span class="s"><span class="dl">"</span><span class="ch">\t</span><span class="k">./check_fc_setra.rb HOST COMMUNITY [EXCLUSIONS]</span><span class=
"dl">"</span></span>
puts <span class="s"><span class="dl">"</span><span class=
"k">Les ports exclus évitent des remontées d'alertes pour les ports non branchés.</span><span class="dl">"</span></span>
puts <span class="s"><span class="dl">"</span><span class="k">Exemple: ./check_fc_setra.rb switch_san_a public 1,4,9</span><span class="dl">"</span></span>
exit <span class="i">2</span>


host = <span class="pc">ARGV</span>.shift
community = <span class="pc">ARGV</span>.shift
exclusions = (<span class="pc">ARGV</span>.shift || <span class="s"><span class="dl">"</span><span class="k">none</span><span class=
"dl">"</span></span>).split(<span class="s"><span class="dl">"</span><span class="k">,</span><span class="dl">"</span></span>)

command = <span class="sh"><span class="dl">`</span><span class="k">snmpwalk -c </span><span class="il"><span class="idl">#{</span>community<span class=
"idl">}</span></span><span class="k"> -v 2c </span><span class="il"><span class="idl">#{</span>host<span class="idl">}</span></span><span class=
"k"> .1.3.6.1.4.1.289.2.1.1.2.3.1.1.2</span><span class="dl">`</span></span>
result = []
command.each <span class="r">do</span> |line|
<span class="c">#puts "DEBUG snmpwalk: "+line</span>
matches = line.match <span class="rx"><span class="dl">/</span><span class="ch">\.</span><span class="k">(</span><span class="ch">\d</span><span class=
"k">+) = INTEGER: (</span><span class="ch">\d</span><span class="k">+)</span><span class="dl">/</span></span>
result.push [matches[<span class="i">1</span>], matches[<span class="i">2</span>]]

not_ignored = result.select{|x| !exclusions.include? x[<span class="i">0</span>]}
interfaces_down = not_ignored.select{|v| v[<span class="i">1</span>] == <span class="s"><span class="dl">"</span><span class="k">6</span><span class=
"dl">"</span></span>}.map{|x| x[<span class="i">0</span>]}
interfaces_ok = not_ignored.select{|v| v[<span class="i">1</span>] == <span class="s"><span class="dl">"</span><span class="k">2</span><span class=
"dl">"</span></span>}.map{|x| x[<span class="i">0</span>]}
interfaces_unknown = not_ignored.map{|x| x[<span class="i">0</span>]} - interfaces_ok - interfaces_down
interfaces_ok_not_normal = (result - not_ignored).select{|v| v[<span class="i">1</span>] == <span class="s"><span class="dl">"</span><span class=
"k">2</span><span class="dl">"</span></span>}.map{|x| x[<span class="i">0</span>]}
puts <span class="s"><span class="dl">"</span><span class="k">Link DOWN on interfaces : </span><span class=
"dl">"</span></span>+interfaces_down.join(<span class="s"><span class="dl">"</span><span class="k">,</span><span class="dl">"</span></span>) <span class=
"r">unless</span> interfaces_down.empty?
puts <span class="s"><span class="dl">"</span><span class="k">Link UP on IGNORED interfaces : </span><span class=
"dl">"</span></span>+interfaces_ok_not_normal.join(<span class="s"><span class="dl">"</span><span class="k">,</span><span class=
"dl">"</span></span>)+<span class="s"><span class="dl">"</span><span class="ch">\n</span><span class="k">!!!CHANGE THE SERVICE CONFIG!!!</span><span class=
"dl">"</span></span> <span class="r">unless</span> interfaces_ok_not_normal.empty?
puts <span class="s"><span class="dl">"</span><span class="k">State UNKNOWN : </span><span class="dl">"</span></span>+interfaces_unknown.join(<span class=
"s"><span class="dl">"</span><span class="k">,</span><span class="dl">"</span></span>) <span class="r">unless</span> interfaces_unknown.empty?
puts <span class="s"><span class="dl">"</span><span class="k">Link UP on interfaces : </span><span class="dl">"</span></span>+interfaces_ok.join(<span class=
"s"><span class="dl">"</span><span class="k">,</span><span class="dl">"</span></span>) <span class="r">unless</span> interfaces_ok.empty?
puts <span class="s"><span class="dl">"</span><span class="k">Ignored: </span><span class="dl">"</span></span>+exclusions.join(<span class="s"><span class=
"dl">"</span><span class="k">,</span><span class="dl">"</span></span>)
exit <span class="co">STATE_CRITICAL</span>
exit <span class="co">STATE_UNKNOWN</span>
exit <span class="co">STATE_OK</span>
  </div>
</div>
